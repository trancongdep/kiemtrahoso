<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Hồ Sơ QLKT & QLVH - Version 1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-sm">

    <div class="container mx-auto p-4 max-w-6xl">
        
        <header class="bg-blue-700 text-white p-4 rounded-t-lg shadow-md flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold uppercase"><i class="fas fa-folder-open mr-2"></i>Quản Lý Hồ Sơ QLKT, QLVH TỔ 2</h1>
                <p class="text-blue-200 text-xs mt-1">Version 1.0 - Firebase Connected</p>
            </div>
            <div id="status-indicator" class="flex items-center space-x-2">
                <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                <span class="text-xs">Chưa kết nối</span>
            </div>
        </header>

        <div class="bg-white p-4 shadow-md mb-4 border-b border-gray-200 flex flex-wrap gap-4 items-end">
            <div class="w-full md:w-1/3">
                <label class="block text-gray-700 font-bold mb-2">Chọn Tuyến Đường Dây / Trạm:</label>
                <select id="routeSelect" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500">
                    <option value="" disabled selected>-- Chọn hồ sơ --</option>
                    </select>
            </div>
            
            <div class="flex space-x-2">
                <button onclick="loadData()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded shadow transition">
                    <i class="fas fa-sync-alt mr-1"></i> Tải dữ liệu
                </button>
                <button onclick="saveData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow transition">
                    <i class="fas fa-save mr-1"></i> Lưu thay đổi
                </button>
            </div>
        </div>

        <div class="bg-white shadow-lg rounded-b-lg overflow-hidden">
            <div id="loading" class="hidden flex justify-center items-center p-10">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full leading-normal">
                    <thead>
                        <tr class="bg-gray-200 text-gray-600 uppercase text-xs leading-normal">
                            <th class="py-3 px-6 text-left w-12">STT</th>
                            <th class="py-3 px-6 text-left">Danh Mục Hồ Sơ</th>
                            <th class="py-3 px-6 text-center w-32">Trạng thái (Có/Số lượng)</th>
                            <th class="py-3 px-6 text-center w-32">Thiếu</th>
                            <th class="py-3 px-6 text-left">Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="text-gray-600 text-sm font-light">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-2 rounded shadow-lg transform translate-y-20 transition-transform duration-300 opacity-0">
        Thông báo
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- USER CONFIGURATION ---
        const firebaseConfig = { 
            apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", 
            authDomain: "tavietnam-78ae8.firebaseapp.com", 
            projectId: "tavietnam-78ae8", 
            storageBucket: "tavietnam-78ae8.firebasestorage.app", 
            messagingSenderId: "670121705534", 
            appId: "1:670121705534:web:1027ad98550573ad37116f" 
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- DATA DEFINITIONS ---
        // Danh sách các tuyến dựa trên tên file đã upload
        const routes = [
            "AK_VT (An Khánh - Việt Thành)",
            "BL-HX (Bình Lợi - Hỏa Xa)",
            "BT_TDA (Bình Triệu - Thanh Đa)",
            "BT_HBP (Bình Thái - Hiệp Bình Phước)",
            "BT_HX (Bình Triệu - Hỏa Xa)",
            "CL-TDD (Cát Lái - Thủ Đức Đông)",
            "CL-PH (Cát Lái - Phú Hữu)",
            "CL-SM (Cát Lái - Sao Mai)",
            "NR Intel (Nhánh rẽ Intel)",
            "CNC-IT (Công Nghệ Cao - Intel)",
            "CL-CNC (Cát Lái - Công Nghệ Cao)",
            "CNC-TNP (Công Nghệ Cao - Tăng Nhơn Phú)",
            "HBP-HX (Hiệp Bình Phước - Hỏa Xa)",
            "HBP-BT (Hiệp Bình Phước - Bình Triệu)",
            "HBP-TL (Hiệp Bình Phước - Thạnh Lộc)",
            "HBP-BL (Hiệp Bình Phước - Bình Lợi)",
            "HX-HH (Hỏa Xa - Hòa Hưng)",
            "HX-TSN (Hỏa Xa - Tân Sơn Nhất)",
            "HM-TL (Hóc Môn - Thạnh Lộc)",
            "HM-HBP (Hóc Môn - Hiệp Bình Phước)",
            "HM-HX (Hóc Môn - Hỏa Xa)",
            "LT1-ĐH (Linh Trung 1 - Đông Hòa)",
            "NMN TĐ-LT1 (NMN Thủ Đức - Linh Trung 1)",
            "TNP-IT (Tăng Nhơn Phú - Intel)",
            "TC-TĐ (Tân Cảng 2 - Thảo Điền)",
            "TC-XL (Tân Cảng 2 - Xa Lộ)",
            "TC-AK (Tân Cảng 2 - An Khánh)",
            "TĐ-AK-VT (Thủ Đức - An Khánh - Việt Thành)",
            "TH-ĐT (Tân Hiệp - Đông Thạnh)",
            "TĐ-LT2 (Thủ Đức - Linh Trung 2)",
            "TĐ-BT (Thủ Đức - Bình Thái)",
            "TĐ-TDA (Thủ Đức - Thanh Đa)",
            "TĐ-NMĐ (Thủ Đức - NMĐ Thủ Đức)",
            "TĐ-VKC-TC (Thủ Đức - Vikimco - Tân Cảng)",
            "TĐ-TDIEN (Thủ Đức - Thảo Điền)",
            "NR IT (Nhánh rẽ Intel 176-7)",
            "TĐ-TĐB-IT (Thủ Đức - TĐ Bắc - Intel)",
            "TĐ-NMN TĐ (Thủ Đức - NMN Thủ Đức)",
            "TĐB-BA (Thủ Đức Bắc - Bình An)",
            "TA-LT2 (Thuận An - Linh Trung 2)",
            "XL-TC (Xa Lộ - Tân Cảng)",
            "XL-HX (Xa Lộ - Hỏa Xa)",
            "XL-ĐK (Xa Lộ - Đa Kao)",
            "CB-TQ (Cầu Bông - Tân Quy)",
            "CB-CC_CB-ĐH (Cầu Bông - Củ Chi/Đức Hòa)",
            "CB-TPT (Cầu Bông - Tân Phú Trung)",
            "CB-TH (Cầu Bông - Tân Hiệp)",
            "ĐT-TH (Đông Thạnh - Tân Hiệp)",
            "CB-ĐN (Cầu Bông - Đông Nam)",
            "NR ĐNAM (Nhánh rẽ Đông Nam)",
            "CC-KCNTB (Củ Chi 2 - KCN Trảng Bàng)",
            "CC-CC2 (Củ Chi 2 - Củ Chi)",
            "CC-PHĐ (Củ Chi 2 - Phú Hòa Đông)",
            "CC-BĐ (Củ Chi 2 - Bàu Đưng)",
            "HM-ĐT (Hóc Môn - Đông Thạnh)",
            "HM-ĐN (Hóc Môn - Đông Nam)",
            "PHĐ-TQ-TĐ (Phú Hòa Đông - Tân Quy - Tân Định)",
            "PHĐ-TĐ (Phú Hòa Đông - Tân Định)"
        ];

        // Cấu trúc hồ sơ chuẩn (Template)
        const categories = [
            {
                id: "A", title: "A. HSQLVH (Hồ sơ quản lý vận hành)", 
                items: [
                    "Thông số kỹ thuật ĐZ",
                    "Bảng theo dõi đóng cắt",
                    "Bảng Theo dõi Sự cố",
                    "Bảng theo dõi Phụ tải",
                    "Bảng Theo dõi kỹ thuật hành lang",
                    "Bảng theo dõi công tác đại tu",
                    "Bảng tổng hợp tồn tại",
                    "Bảng phân bố cột",
                    "Bảng giao chéo",
                    "Bảng đo độ võng (khi có thay đổi)",
                    "Bảng báo cáo nhiệt độ (6 tháng/1 lần)",
                    "Bảng báo cáo điện trở (1 năm/1 lần)",
                    "Hồ sơ thứ tự pha (khi có thay đổi)",
                    "Hình Ảnh trụ",
                    "Biên bản KTĐK ngày (1 tháng/1 lần)",
                    "Biên bản KTĐK đêm (3 tháng/1 lần)",
                    "Hồ sơ theo dõi nhà / công trình"
                ]
            },
            {
                id: "B", title: "B. HSQLKT (Hồ sơ quản lý kỹ thuật)", 
                subsections: [
                    {
                        title: "I. Hồ sơ thiết kế được duyệt",
                        items: [
                            "Hồ sơ móng trụ",
                            "Hồ sơ đền bù",
                            "Hồ sơ nghiệm thu",
                            "Hồ sơ thiết kế",
                            "Hồ sơ dự thầu"
                        ]
                    },
                    {
                        title: "II. Hồ sơ hoàn công",
                        items: [
                            "Hồ sơ hoàn công phần móng trụ",
                            "Hồ sơ hoàn công phần trụ",
                            "Hồ sơ hoàn công phần dây dẫn, dây chống sét",
                            "Hồ sơ hoàn công phần tiếp địa",
                            "Biên bản nghiệm thu",
                            "Tài liệu của nhà chế tạo"
                        ]
                    }
                ]
            }
        ];

        // --- UI FUNCTIONS ---

        function initApp() {
            // Update status
            const statusIndicator = document.getElementById('status-indicator');
            if(db) {
                statusIndicator.innerHTML = '<span class="w-3 h-3 bg-green-500 rounded-full"></span><span class="text-xs text-green-700 font-bold">Đã kết nối Firebase</span>';
            }

            // Populate Route Dropdown
            const select = document.getElementById('routeSelect');
            routes.forEach(route => {
                const opt = document.createElement('option');
                // Use the code (part before space) as key for DB, full string for display
                const code = route.split(' ')[0].replace(/[^a-zA-Z0-9-_]/g, '_'); 
                opt.value = code;
                opt.textContent = route;
                select.appendChild(opt);
            });

            // Trigger load when route changes
            select.addEventListener('change', () => {
                loadData();
            });

            // Render empty table initially
            renderTable({});
        }

        window.renderTable = (data) => {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            categories.forEach(cat => {
                // Render Category Header
                const catRow = `<tr class="bg-blue-100 font-bold text-blue-800"><td colspan="5" class="py-2 px-6">${cat.title}</td></tr>`;
                tbody.insertAdjacentHTML('beforeend', catRow);

                if (cat.items) {
                    cat.items.forEach((item, index) => {
                        renderRow(tbody, cat.id, index + 1, item, data[`${cat.id}_${index}`]);
                    });
                }

                if (cat.subsections) {
                    cat.subsections.forEach((sub, subIndex) => {
                        const subRow = `<tr class="bg-gray-50 font-semibold text-gray-700"><td colspan="5" class="py-1 px-6 pl-10">${sub.title}</td></tr>`;
                        tbody.insertAdjacentHTML('beforeend', subRow);
                        sub.items.forEach((item, itemIndex) => {
                            // Unique ID construction: CatID_SubIndex_ItemIndex
                            const uniqueKey = `${cat.id}_${subIndex}_${itemIndex}`;
                            renderRow(tbody, uniqueKey, itemIndex + 1, item, data[uniqueKey]);
                        });
                    });
                }
            });
        }

        function renderRow(tbody, idPrefix, stt, name, rowData = {}) {
            const countVal = rowData.count || '';
            const missingVal = rowData.missing || '';
            const noteVal = rowData.note || '';

            const row = `
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="py-2 px-6 text-left whitespace-nowrap">${stt}</td>
                    <td class="py-2 px-6 text-left font-medium">${name}</td>
                    <td class="py-2 px-6 text-center">
                        <input type="text" data-key="${idPrefix}_count" class="w-full text-center border rounded p-1 focus:ring-2 focus:ring-blue-300" placeholder="Có/SL" value="${countVal}">
                    </td>
                    <td class="py-2 px-6 text-center">
                        <input type="text" data-key="${idPrefix}_missing" class="w-full text-center border rounded p-1 focus:ring-2 focus:ring-red-300" placeholder="" value="${missingVal}">
                    </td>
                    <td class="py-2 px-6 text-left">
                        <input type="text" data-key="${idPrefix}_note" class="w-full border rounded p-1 focus:ring-2 focus:ring-blue-300" placeholder="..." value="${noteVal}">
                    </td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
        }

        // --- FIREBASE OPERATIONS ---

        window.saveData = () => {
            const routeCode = document.getElementById('routeSelect').value;
            if (!routeCode) {
                showToast("Vui lòng chọn tuyến đường dây trước!", "error");
                return;
            }

            const inputs = document.querySelectorAll('input[data-key]');
            const dataToSave = {};

            inputs.forEach(input => {
                const parts = input.dataset.key.split('_');
                const field = parts.pop(); // count, missing, or note
                const itemKey = parts.join('_');

                if (!dataToSave[itemKey]) dataToSave[itemKey] = {};
                dataToSave[itemKey][field] = input.value;
            });

            // Metadata
            dataToSave.lastUpdated = new Date().toISOString();

            const dbRef = ref(db, 'records/' + routeCode);
            set(dbRef, dataToSave)
                .then(() => {
                    showToast("Đã lưu dữ liệu thành công!", "success");
                })
                .catch((error) => {
                    console.error(error);
                    showToast("Lỗi khi lưu: " + error.message, "error");
                });
        };

        window.loadData = () => {
            const routeCode = document.getElementById('routeSelect').value;
            if (!routeCode) return;

            const loader = document.getElementById('loading');
            loader.classList.remove('hidden');
            
            const dbRef = ref(db);
            get(child(dbRef, `records/${routeCode}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    renderTable(snapshot.val());
                    showToast("Đã tải dữ liệu.", "info");
                } else {
                    renderTable({}); // Clear table for new entry
                    showToast("Chưa có dữ liệu cho tuyến này. Mời nhập mới.", "info");
                }
            }).catch((error) => {
                console.error(error);
                showToast("Lỗi tải dữ liệu.", "error");
            }).finally(() => {
                loader.classList.add('hidden');
            });
        };

        function showToast(message, type = "info") {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            
            if (type === 'error') toast.className = "fixed bottom-5 right-5 bg-red-600 text-white px-4 py-2 rounded shadow-lg transform translate-y-0 transition-transform duration-300 z-50";
            else if (type === 'success') toast.className = "fixed bottom-5 right-5 bg-green-600 text-white px-4 py-2 rounded shadow-lg transform translate-y-0 transition-transform duration-300 z-50";
            else toast.className = "fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-2 rounded shadow-lg transform translate-y-0 transition-transform duration-300 z-50";

            toast.style.opacity = "1";
            
            setTimeout(() => {
                toast.style.opacity = "0";
                toast.style.transform = "translateY(20px)";
            }, 3000);
        }

        // Start App
        initApp();
    </script>
</body>
</html>
